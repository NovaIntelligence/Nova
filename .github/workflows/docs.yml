name: docs

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'docs/**'
      - 'README.md'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Generate docs index
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Force -Path 'artifacts/docs' | Out-Null
          $md = @()
          if (Test-Path 'docs') { $md += Get-ChildItem -Recurse -Path 'docs' -Filter *.md -File }
          $content = "# Documentation Index`n`n## README`n- [README](README.md)`n`n## Docs`n" + ($md | ForEach-Object { "- [$($_.FullName.Replace((Get-Location).Path + [System.IO.Path]::DirectorySeparatorChar, ''))]($($_.FullName.Replace((Get-Location).Path + [System.IO.Path]::DirectorySeparatorChar, '')) )" } | Out-String)
          $content | Set-Content 'artifacts/docs/index.md'
      - name: Upload docs artifact
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874
        with:
          name: docs-index
          path: artifacts/docs/*
