name: Nova Bot CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  POWERSHELL_TELEMETRY_OPTOUT: 1

jobs:
  test:
    name: Test Nova Bot
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup PowerShell 7
      uses: azure/powershell@v2
      with:
        azPSVersion: "latest"
        inlineScript: |
          # Install PowerShell 7 if not present
          if (-not (Get-Command pwsh -ErrorAction SilentlyContinue)) {
            Write-Host "Installing PowerShell 7..."
            Invoke-WebRequest -Uri "https://github.com/PowerShell/PowerShell/releases/latest/download/PowerShell-7.4.6-win-x64.msi" -OutFile "pwsh.msi"
            Start-Process msiexec.exe -ArgumentList "/i", "pwsh.msi", "/quiet" -Wait
          }
          
    - name: Install Pester v5
      shell: pwsh
      run: |
        Write-Host "Installing Pester v5..."
        Install-Module -Name Pester -MinimumVersion 5.0 -Force -SkipPublisherCheck
        Import-Module Pester -Force
        Get-Module Pester | Select-Object Name, Version
        
    - name: Create Artifact Directories
      shell: pwsh
      run: |
        New-Item -Path "ci-artifacts" -ItemType Directory -Force
        New-Item -Path "ci-artifacts/logs" -ItemType Directory -Force
        New-Item -Path "ci-artifacts/coverage" -ItemType Directory -Force
        
    - name: Run Preflight Checks
      shell: powershell -Version 5.1 -Command
      run: |
        Write-Host "=== Nova Bot Preflight Checks ===" -ForegroundColor Cyan
        if (Test-Path "tools\Preflight.ps1") {
          powershell -ExecutionPolicy Bypass -Version 5.1 -File "tools\Preflight.ps1"
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Preflight checks failed with exit code: $LASTEXITCODE"
            exit $LASTEXITCODE
          }
        } else {
          Write-Warning "Preflight.ps1 not found, skipping preflight checks"
        }
        
    - name: Run Test Suite
      shell: pwsh
      run: |
        Write-Host "=== Nova Bot Test Suite ===" -ForegroundColor Cyan
        
        # Ensure we're using PowerShell 7 with Pester v5
        Import-Module Pester -MinimumVersion 5.0 -Force
        
        # Check if custom test runner exists, otherwise use direct Pester
        if (Test-Path "tools\Run-Tests.ps1") {
          Write-Host "Running custom test suite via tools\Run-Tests.ps1"
          pwsh -ExecutionPolicy Bypass -File "tools\Run-Tests.ps1"
          $exitCode = $LASTEXITCODE
        } elseif (Test-Path "tests\FailureInjection.Tests.ps1") {
          Write-Host "Running tests directly with Pester v5"
          $result = Invoke-Pester -Path "tests\*.Tests.ps1" -PassThru -OutputFormat NUnitXml -OutputFile "ci-artifacts\test-results.xml"
          $exitCode = if ($result.FailedCount -gt 0) { 1 } else { 0 }
        } else {
          Write-Warning "No test files found, treating as success"
          $exitCode = 0
        }
        
        if ($exitCode -ne 0) {
          Write-Error "Test suite failed with exit code: $exitCode"
          exit $exitCode
        }
        
    - name: Collect Log Artifacts
      if: always()
      shell: pwsh
      run: |
        Write-Host "=== Collecting Log Artifacts ===" -ForegroundColor Yellow
        
        # Collect logs from various locations
        $logSources = @(
          "logs\*.log",
          "logs\*.txt", 
          "data\*.log",
          "*.log",
          "bot\*.log"
        )
        
        foreach ($pattern in $logSources) {
          $files = Get-ChildItem -Path $pattern -ErrorAction SilentlyContinue
          foreach ($file in $files) {
            $relativePath = $file.FullName.Replace((Get-Location).Path + "\", "")
            Write-Host "Collecting: $relativePath"
            Copy-Item $file.FullName "ci-artifacts\logs\" -Force -ErrorAction SilentlyContinue
          }
        }
        
        # Create CI summary log
        @"
        Nova Bot CI Run Summary
        =======================
        Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
        Branch: ${{ github.ref_name }}
        Commit: ${{ github.sha }}
        Workflow: ${{ github.workflow }}
        Job: ${{ github.job }}
        Runner: ${{ runner.os }}
        "@ | Out-File "ci-artifacts\ci-summary.log" -Encoding UTF8
        
    - name: Collect Coverage Data
      if: always()
      shell: pwsh
      run: |
        Write-Host "=== Collecting Coverage Data ===" -ForegroundColor Yellow
        
        # Look for any coverage files generated by tests
        $coverageFiles = Get-ChildItem -Path @("coverage.xml", "*.coverage", "coverage\*") -Recurse -ErrorAction SilentlyContinue
        
        foreach ($file in $coverageFiles) {
          $relativePath = $file.FullName.Replace((Get-Location).Path + "\", "")
          Write-Host "Collecting coverage: $relativePath"
          Copy-Item $file.FullName "ci-artifacts\coverage\" -Force -ErrorAction SilentlyContinue
        }
        
        # If no coverage found, create placeholder
        if (-not (Get-ChildItem "ci-artifacts\coverage" -ErrorAction SilentlyContinue)) {
          "No coverage data generated for this run" | Out-File "ci-artifacts\coverage\no-coverage.txt" -Encoding UTF8
        }
        
    - name: Archive Lessons Folder
      if: always()
      shell: pwsh
      run: |
        Write-Host "=== Archiving Lessons Folder ===" -ForegroundColor Yellow
        
        if (Test-Path "lessons") {
          # Copy lessons directory structure
          Copy-Item "lessons" "ci-artifacts\lessons" -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "Lessons folder archived successfully"
        } else {
          Write-Host "No lessons folder found, creating placeholder"
          New-Item -Path "ci-artifacts\lessons" -ItemType Directory -Force
          "No lessons data available" | Out-File "ci-artifacts\lessons\no-lessons.txt" -Encoding UTF8
        }
        
    - name: Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: nova-ci-artifacts-${{ github.run_number }}
        path: ci-artifacts/
        retention-days: 30
        
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ github.run_number }}
        path: |
          ci-artifacts/test-results.xml
          ci-artifacts/logs/
        retention-days: 14

  security:
    name: Security Scan
    runs-on: windows-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Run Security Checks
      shell: pwsh
      run: |
        Write-Host "=== Security Scan ===" -ForegroundColor Cyan
        
        # Check for sensitive patterns
        $sensitivePatterns = @(
          "password\s*=\s*['\`"][^'\`"]+['\`"]",
          "api[_-]?key\s*=\s*['\`"][^'\`"]+['\`"]",
          "secret\s*=\s*['\`"][^'\`"]+['\`"]",
          "token\s*=\s*['\`"][^'\`"]+['\`"]"
        )
        
        $issues = @()
        Get-ChildItem -Recurse -Include "*.ps1", "*.py", "*.js", "*.json" | ForEach-Object {
          $content = Get-Content $_.FullName -Raw -ErrorAction SilentlyContinue
          if ($content) {
            foreach ($pattern in $sensitivePatterns) {
              if ($content -match $pattern) {
                $issues += "Potential credential in: $($_.FullName)"
              }
            }
          }
        }
        
        if ($issues.Count -gt 0) {
          Write-Warning "Security issues found:"
          $issues | ForEach-Object { Write-Warning "  $_" }
          # Don't fail the build, just warn for now
        } else {
          Write-Host "âœ… No obvious security issues detected" -ForegroundColor Green
        }