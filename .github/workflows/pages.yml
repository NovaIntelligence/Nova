name: pages

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build static docs index
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Force -Path 'public' | Out-Null
          New-Item -ItemType Directory -Force -Path 'public/docs' | Out-Null
          $title = 'Nova Documentation'
          $readmeLink = 'https://github.com/NovaIntelligence/Nova/blob/main/README.md'
          $docs = if (Test-Path 'docs') { Get-ChildItem -Recurse -Path 'docs' -Filter *.md -File } else { @() }
          $docsList = $docs | ForEach-Object { "<li><a href='https://github.com/NovaIntelligence/Nova/blob/main/$($_.FullName.Replace((Get-Location).Path + [System.IO.Path]::DirectorySeparatorChar, ''))' target='_blank'>$($_.Name)</a></li>" } | Out-String
          $html = @"
          <!doctype html>
          <html lang='en'>
          <head>
            <meta charset='utf-8'/>
            <meta name='viewport' content='width=device-width, initial-scale=1'/>
            <title>$title</title>
            <style>body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:40px; max-width:900px} .muted{color:#666}</style>
          </head>
          <body>
            <h1>$title</h1>
            <p>Start with the <a href='$readmeLink' target='_blank'>README</a>. Below are Markdown docs in the repository.</p>
            <h2>Docs</h2>
            <ul>
            $docsList
            </ul>
            <p class='muted'>This page is auto-generated by the Pages workflow.</p>
          </body>
          </html>
          "@
          $html | Set-Content 'public/index.html'

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
